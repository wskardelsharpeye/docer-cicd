pipeline {
    agent any
    
    tools {
        maven 'Maven3'
    }
    
    stages {
        stage('Build') {
            steps {
                sh 'mvn clean package -DskipTests'
            }
        }
        
        stage('Test') {
            steps {
                sh 'mvn test'
            }
        }
        
        stage('Docker Build') {
            steps {
                sh 'docker build -t app-image:${BUILD_NUMBER} .'
            }
        }
        
        stage('Deploy') {
            steps {
                // 使用Docker Pipeline插件部署容器
                script {
                    // 停止并删除旧容器（如果存在）
                    sh 'docker stop app-container || true'
                    sh 'docker rm app-container || true'
                    
                    // 运行新容器
                    docker.image("app-image:${BUILD_NUMBER}").run(
                        "--name app-container -p 8081:8081 -v ${WORKSPACE}/logs:/app/logs"
                    )
                }
            }
        }
    }
    
    post {
        success {
            echo '部署成功'
        }
        failure {
            echo '部署失败'
        }
    }
}